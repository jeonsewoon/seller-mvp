<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="theme-color" content="#0b0b0c">
  <title>뜻밖의시장 | 관리자</title>

  <style>
    :root{
      --bg:#0b0b0c; --card:#16161a; --soft:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.12); --muted:#b2b2b8;
      --ok:rgba(170,255,205,.95); --bad:rgba(255,180,180,.95);
    }
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;background:var(--bg);color:#f4f4f6}
    .wrap{max-width:1100px;margin:0 auto;padding:20px 16px 92px}
    h1{font-size:24px;margin:0 0 6px}
    h2{font-size:16px;margin:0 0 10px}
    .muted{color:var(--muted);font-size:13px;line-height:1.5}
    .card{margin-top:14px;padding:16px;border-radius:16px;background:var(--card);border:1px solid var(--line)}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:860px){ .grid{grid-template-columns:1fr 1fr 1fr} }
    label{display:block;font-size:12px;color:#d0d0d6;margin:10px 0 6px}
    input,select,textarea{
      width:100%;padding:11px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);color:#fff;font-size:14px;outline:none
    }
    textarea{min-height:86px;resize:vertical}
    input::placeholder{color:rgba(255,255,255,.35)}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{border:0;padding:12px 14px;border-radius:14px;background:#fff;color:#000;font-weight:900;cursor:pointer}
    .btn.sub{background:rgba(255,255,255,.10);color:#fff;font-weight:800;border:1px solid rgba(255,255,255,.16)}
    .btn.danger{background:rgba(255,120,120,.10);color:#ffdede;border:1px solid rgba(255,120,120,.25)}
    .pill{display:inline-block;font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.16);color:#cfcfd3;background:rgba(255,255,255,.05)}
    .pill.ok{border-color:rgba(120,255,180,.22);color:var(--ok);background:rgba(120,255,180,.06)}
    .pill.bad{border-color:rgba(255,120,120,.22);color:var(--bad);background:rgba(255,120,120,.06)}
    .list{display:flex;flex-direction:column;gap:8px}
    .item{
      padding:12px;border-radius:14px;background:var(--soft);border:1px solid var(--line);
      cursor:pointer
    }
    .item b{font-size:15px}
    .row{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .tiny{font-size:12px;color:var(--muted)}
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:16px;z-index:50;background:rgba(0,0,0,.82);
      border:1px solid rgba(255,255,255,.18);padding:10px 12px;border-radius:999px;
      font-size:13px;display:none;max-width:92vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis
    }
    .err{
      margin-top:10px;padding:12px 14px;border-radius:14px;border:1px solid rgba(255,120,120,.22);
      background:rgba(255,120,120,.06);color:#ffdede;font-size:13px;line-height:1.5;white-space:pre-wrap
    }
    /* 위/경도 UI는 숨김(코드는 유지) */
    .geo-hidden{display:none !important;}
  </style>
</head>

<body>
<div class="wrap">
  <h1>뜻밖의시장 관리자</h1>
  <div class="muted">events.json을 안전한 포맷(영문 키)으로만 저장합니다. (빈 행사 저장 방지)</div>

  <div class="card" id="settingsCard">
    <h2>GitHub 저장 설정</h2>
    <div class="muted">events.json 저장에만 사용합니다. 토큰은 이 브라우저에만 저장됩니다.</div>
    <div class="hr"></div>
    <div class="grid">
      <div><label>Repo Owner</label><input id="ghOwner" value="jeonsewoon"></div>
      <div><label>Repo Name</label><input id="ghRepo" value="seller-mvp"></div>
      <div><label>Branch</label><input id="ghBranch" value="main"></div>
      <div style="grid-column:1/-1">
        <label>GitHub Token (Fine-grained / Contents: Read & write)</label>
        <input id="ghToken" placeholder="github_pat_...">
        <div class="tiny">⚠️ 토큰은 절대 공유하지 마세요.</div>
      </div>
    </div>
    <div class="btnRow">
      <button class="btn sub" id="saveTokenBtn" type="button">토큰 저장</button>
      <button class="btn danger" id="clearTokenBtn" type="button">토큰 삭제</button>
      <span class="pill" id="tokenStatus">토큰: 없음</span>
    </div>
  </div>

  <div class="card">
    <h2>행사 추가 / 수정</h2>
    <div class="muted">행사명·시작일·종료일·정원은 필수입니다. (없으면 저장 자체가 안 됩니다)</div>
    <div class="hr"></div>

    <div class="grid">
      <div>
        <label>행사명 *</label>
        <input id="ev_name" placeholder="예) 동탄역파라곤">
      </div>
      <div>
        <label>지역(area)</label>
        <input id="ev_area" placeholder="예) 동탄">
      </div>
      <div>
        <label>정원(capacity) *</label>
        <input id="ev_capacity" type="number" min="0" placeholder="예) 30">
      </div>

      <div>
        <label>시작(start) *</label>
        <input id="ev_start" type="date">
      </div>
      <div>
        <label>종료(end) *</label>
        <input id="ev_end" type="date">
      </div>
      <div>
        <label>현재(current)</label>
        <input id="ev_current" type="number" min="0" placeholder="예) 0">
      </div>

      <div style="grid-column:1/-1">
        <label>주소(address)</label>
        <input id="ev_address" placeholder="예) 경기도 화성시 ...">
      </div>

      <!-- 위/경도는 UI 숨김 -->
      <div class="geo-hidden">
        <label>위도(lat)</label>
        <input id="ev_lat" readonly>
      </div>
      <div class="geo-hidden">
        <label>경도(lng)</label>
        <input id="ev_lng" readonly>
      </div>

      <div style="grid-column:1/-1">
        <label>메모(note)</label>
        <input id="ev_note" placeholder="선택">
      </div>
    </div>

    <div class="btnRow">
      <button class="btn" id="addUpdateBtn" type="button">행사 추가/수정</button>
      <button class="btn sub" id="resetFormBtn" type="button">입력 초기화</button>

      <!-- ✅ 네가 요청한 “취소/삭제” -->
      <button class="btn danger" id="deleteBtn" type="button" disabled>행사 취소(삭제)</button>
    </div>

    <div id="eventsErr" class="err" style="display:none"></div>

    <div class="hr"></div>
    <div class="btnRow">
      <button class="btn sub" id="reloadEventsBtn" type="button">events.json 다시 불러오기</button>
      <button class="btn" id="saveEventsToGitBtn" type="button">GitHub에 저장(events.json)</button>
      <span class="pill" id="eventsCount">0개</span>
    </div>

    <div class="hr"></div>
    <h2>행사 목록</h2>
    <div class="muted">아래 목록에서 행사를 클릭하면 수정/삭제 대상으로 선택됩니다.</div>
    <div class="hr"></div>
    <div class="list" id="eventsList"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  const LS_GH = "um_gh_settings_v1";

  const EVENT_KEYS = ["id","name","area","start","end","address","lat","lng","capacity","current","note"];
  let EVENTS = [];
  let selectedEventId = null;

  const $ = (id)=>document.getElementById(id);
  const toastEl = $("toast");
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(window.__t);
    window.__t = setTimeout(()=> toastEl.style.display="none", 2000);
  }
  function showErr(msg){
    const el = $("eventsErr");
    el.style.display = msg ? "block" : "none";
    el.textContent = msg || "";
  }
  function safeStr(v){ return (v==null) ? "" : String(v); }
  function num(v, d=0){ const n = Number(v); return Number.isFinite(n) ? n : d; }
  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  function loadGh(){
    try { return JSON.parse(localStorage.getItem(LS_GH)) || {}; } catch { return {}; }
  }
  function saveGh(obj){
    localStorage.setItem(LS_GH, JSON.stringify(obj));
    refreshTokenStatus();
  }
  function getGh(){
    const s = loadGh();
    return {
      owner: s.owner || $("ghOwner").value.trim(),
      repo: s.repo || $("ghRepo").value.trim(),
      branch: s.branch || $("ghBranch").value.trim(),
      token: s.token || $("ghToken").value.trim()
    };
  }
  function refreshTokenStatus(){
    const s = loadGh();
    const ok = !!(s.token && s.owner && s.repo && s.branch);
    $("tokenStatus").textContent = ok ? "토큰: 저장됨" : "토큰: 없음";
    $("tokenStatus").className = ok ? "pill ok" : "pill";
    if(s.owner) $("ghOwner").value = s.owner;
    if(s.repo) $("ghRepo").value = s.repo;
    if(s.branch) $("ghBranch").value = s.branch;
    if(s.token) $("ghToken").value = s.token;
  }

  async function ghGetFile(path){
    const {owner,repo,branch} = getGh();
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${encodeURIComponent(branch)}`;
    const res = await fetch(url, { headers: { "Accept":"application/vnd.github+json" }});
    if(!res.ok) throw new Error(`GitHub GET 실패: ${path} (${res.status})`);
    return await res.json();
  }
  async function ghPutFile(path, contentText, message){
    const {owner,repo,branch,token} = getGh();
    if(!token) throw new Error("토큰이 없습니다. 상단에서 토큰 저장 후 다시 시도하세요.");

    let sha = null;
    try {
      const cur = await ghGetFile(path);
      sha = cur.sha;
    } catch(e){
      if(!String(e.message).includes("(404)")) throw e;
    }

    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
    const body = {
      message,
      content: btoa(unescape(encodeURIComponent(contentText))),
      branch
    };
    if(sha) body.sha = sha;

    const res = await fetch(url, {
      method:"PUT",
      headers:{
        "Accept":"application/vnd.github+json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify(body)
    });

    if(res.status === 401) throw new Error("401 Bad credentials (토큰 권한/만료). Fine-grained 토큰 Contents(Read&Write) + repo(seller-mvp) 확인.");
    if(res.status === 409) throw new Error("409 Conflict (파일 sha 불일치). 'events.json 다시 불러오기' 후 저장하세요.");
    if(!res.ok) throw new Error(`GitHub PUT 실패: ${path} (${res.status})`);
    return await res.json();
  }

  function toISODate(v){
    const s = safeStr(v).trim();
    if(!s) return "";
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    if(/^\d{8}$/.test(s)) return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
    const m = s.match(/(\d{4})\D+(\d{1,2})\D+(\d{1,2})/);
    if(m){
      const y=m[1], mm=String(m[2]).padStart(2,"0"), dd=String(m[3]).padStart(2,"0");
      return `${y}-${mm}-${dd}`;
    }
    return "";
  }

  function normalizeEvent(raw){
    const area = safeStr(raw.area ?? raw["지역"]).replace(/\u200B|\u200C|\u200D|\uFEFF/g,"").trim();
    return {
      id: safeStr(raw.id || "").trim() || ("ev_" + Date.now()),
      name: safeStr(raw.name ?? raw["행사명"] ?? raw["name"]).trim(),
      area,
      start: toISODate(raw.start ?? raw["시작"] ?? raw["start"]),
      end: toISODate(raw.end ?? raw["끝"] ?? raw["end"]),
      address: safeStr(raw.address ?? raw["주소"] ?? raw["address"]).trim(),
      lat: null,
      lng: null,
      capacity: num(raw.capacity ?? raw["정원"] ?? raw["용량"] ?? raw["수용 능력"], 0),
      current: num(raw.current ?? raw["현재"], 0),
      note: safeStr(raw.note ?? raw["메모"] ?? raw["note"]).trim()
    };
  }

  function validateEvent(ev){
    if(!ev.name) return "행사명(name)은 필수입니다.";
    if(!ev.start) return "시작일(start)은 필수입니다.";
    if(!ev.end) return "종료일(end)은 필수입니다.";
    if(!/^\d{4}-\d{2}-\d{2}$/.test(ev.start)) return "시작일은 YYYY-MM-DD 형식이어야 합니다.";
    if(!/^\d{4}-\d{2}-\d{2}$/.test(ev.end)) return "종료일은 YYYY-MM-DD 형식이어야 합니다.";
    if(ev.capacity < 0) return "정원(capacity)은 0 이상이어야 합니다.";
    if(ev.current < 0) return "현재(current)는 0 이상이어야 합니다.";
    return "";
  }

  function cleanEvents(list){
    // ✅ undefined/빈 행사 제거 + 표준화
    const cleaned = list
      .map(normalizeEvent)
      .filter(ev => ev.name && ev.start && ev.end);
    // 날짜순 정렬
    cleaned.sort((a,b)=> (a.start||"").localeCompare(b.start||""));
    return cleaned;
  }

  function fillEventForm(ev){
    $("ev_name").value = ev.name || "";
    $("ev_area").value = ev.area || "";
    $("ev_start").value = ev.start || "";
    $("ev_end").value = ev.end || "";
    $("ev_address").value = ev.address || "";
    $("ev_capacity").value = String(ev.capacity ?? 0);
    $("ev_current").value = String(ev.current ?? 0);
    $("ev_note").value = ev.note || "";
    $("deleteBtn").disabled = false;
  }

  function resetEventForm(){
    selectedEventId = null;
    ["ev_name","ev_area","ev_start","ev_end","ev_address","ev_capacity","ev_current","ev_note"]
      .forEach(id=>$(id).value="");
    $("deleteBtn").disabled = true;
  }

  function getEventForm(){
    return normalizeEvent({
      id: selectedEventId || ("ev_" + Date.now()),
      name: $("ev_name").value,
      area: $("ev_area").value,
      start: $("ev_start").value,
      end: $("ev_end").value,
      address: $("ev_address").value,
      capacity: $("ev_capacity").value,
      current: $("ev_current").value,
      note: $("ev_note").value
    });
  }

  function renderEvents(){
    $("eventsCount").textContent = `${EVENTS.length}개`;
    const wrap = $("eventsList");
    wrap.innerHTML = "";
    if(!EVENTS.length){
      wrap.innerHTML = `<div class="muted">행사가 없습니다.</div>`;
      return;
    }
    EVENTS.forEach(ev=>{
      const cap = num(ev.capacity,0);
      const cur = num(ev.current,0);
      const full = (cap>0 && cur>=cap);
      const div = document.createElement("div");
      div.className = "item";
      div.onclick = ()=>{
        selectedEventId = ev.id;
        fillEventForm(ev);
        toast("행사 선택됨");
      };
      div.innerHTML = `
        <div class="row">
          <div>
            <b>${escapeHtml(ev.name)}</b>
            <span class="pill ${full ? "bad" : "ok"}">${full ? "마감" : "모집중"}</span>
            <div class="tiny">${escapeHtml(ev.start)} ~ ${escapeHtml(ev.end)} · ${escapeHtml(ev.area || "")}</div>
            <div class="tiny">${escapeHtml(ev.address || "")}</div>
          </div>
          <div class="tiny">${cur}/${cap || "-"}</div>
        </div>
      `;
      wrap.appendChild(div);
    });
  }

  async function loadEvents(){
    showErr("");
    const res = await fetch(`./events.json?ts=${Date.now()}`, {cache:"no-store"});
    if(!res.ok) throw new Error(`events.json 로딩 실패 (${res.status})`);
    const data = await res.json();
    if(!Array.isArray(data)) throw new Error("events.json 형식 오류(배열 아님)");
    EVENTS = cleanEvents(data);
    selectedEventId = null;
    resetEventForm();
    renderEvents();
  }

  async function saveEventsToGitHub(){
    showErr("");
    EVENTS = cleanEvents(EVENTS);
    for(const ev of EVENTS){
      const err = validateEvent(ev);
      if(err) throw new Error(`저장 불가: ${ev.name}\n- ${err}`);
    }
    const text = JSON.stringify(EVENTS, null, 2);
    await ghPutFile("events.json", text, "Update events.json via admin");
    toast("✅ events.json 저장 완료");
  }

  // 토큰 버튼
  $("saveTokenBtn").addEventListener("click", ()=>{
    const s = {
      owner: $("ghOwner").value.trim(),
      repo: $("ghRepo").value.trim(),
      branch: $("ghBranch").value.trim(),
      token: $("ghToken").value.trim()
    };
    saveGh(s);
    toast("토큰 저장됨");
  });
  $("clearTokenBtn").addEventListener("click", ()=>{
    localStorage.removeItem(LS_GH);
    refreshTokenStatus();
    toast("토큰 삭제됨");
  });

  // 행사 추가/수정
  $("addUpdateBtn").addEventListener("click", ()=>{
    showErr("");
    try{
      const ev = getEventForm();
      const err = validateEvent(ev);
      if(err) throw new Error(err);

      const idx = EVENTS.findIndex(x=>x.id === ev.id);
      if(idx >= 0) EVENTS[idx] = ev;
      else EVENTS.push(ev);

      EVENTS = cleanEvents(EVENTS);
      selectedEventId = ev.id;
      renderEvents();
      toast(idx>=0 ? "행사 수정됨(로컬)" : "행사 추가됨(로컬)");
    }catch(e){
      showErr(`저장 실패: ${e.message}`);
    }
  });

  // 입력 초기화
  $("resetFormBtn").addEventListener("click", ()=> resetEventForm());

  // ✅ 행사 취소(삭제)
  $("deleteBtn").addEventListener("click", ()=>{
    if(!selectedEventId){ toast("삭제할 행사를 먼저 선택"); return; }
    const ev = EVENTS.find(x=>x.id===selectedEventId);
    if(!confirm(`행사를 취소(삭제)할까요?\n- ${ev?.name || selectedEventId}`)) return;

    EVENTS = EVENTS.filter(x=>x.id!==selectedEventId);
    EVENTS = cleanEvents(EVENTS);
    resetEventForm();
    renderEvents();
    toast("행사 취소(삭제) 완료 (로컬)");
  });

  // 다시 불러오기
  $("reloadEventsBtn").addEventListener("click", ()=>{
    loadEvents().then(()=>toast("events.json 다시 불러옴")).catch(e=>showErr(e.message));
  });

  // GitHub 저장
  $("saveEventsToGitBtn").addEventListener("click", ()=>{
    saveEventsToGitHub().catch(e=>showErr(e.message));
  });

  // boot
  refreshTokenStatus();
  loadEvents().catch(e=>showErr(e.message));
</script>
</body>
</html>
