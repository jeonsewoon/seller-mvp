<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>뜻밖의시장 | 셀러 모집</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0b0b0c; --card:#16161a; --muted:#a7a7aa; --text:#f4f4f6;
      --line:#2a2a2f; --chip:#0f0f12; --accent:#ffffff;
      --ok:#35c759; --warn:#ffcc00; --danger:#ff4d4f;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo",system-ui,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:22px}
    .title{font-size:38px;font-weight:900;letter-spacing:-1px}
    .sub{margin-top:6px;color:var(--muted);font-size:14px}
    .card{margin-top:16px;background:var(--card);border:1px solid var(--line);border-radius:22px;padding:16px}
    .card h2{margin:0;font-size:16px}
    .help{margin-top:8px;color:var(--muted);font-size:13px}
    #map{height:360px;margin-top:10px;border-radius:16px;overflow:hidden;border:1px solid var(--line)}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > *{flex:1 1 260px}
    .barItem{margin-top:10px}
    .barTop{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .barName{font-weight:900}
    .barNum{color:var(--muted);font-weight:700}
    .barBg{margin-top:8px;height:12px;border-radius:999px;background:#2a2a2f;border:1px solid #3a3a40;overflow:hidden}
    .barFill{height:100%;background:#fff;border-radius:999px;width:0%}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .eventCard{
      border:1px solid var(--line);background:var(--chip);border-radius:16px;
      padding:14px;cursor:pointer;transition:.15s transform ease
    }
    .eventCard:active{transform:scale(.995)}
    .eventName{font-weight:900;font-size:16px}
    .eventMeta{margin-top:6px;color:var(--muted);font-size:13px}
    .badge{
      display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);
      border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)
    }
    .badge.ok{border-color:#2e7d32;color:#c8f7d2}
    .badge.done{border-color:#6b6b70;color:#d0d0d2}
    .selectedBox{
      margin-top:10px;border:1px dashed #3a3a40;border-radius:16px;padding:12px;color:var(--muted)
    }
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      border:0;border-radius:14px;padding:14px 16px;font-weight:900;cursor:pointer;
      background:var(--accent);color:#000
    }
    .btn.secondary{background:#2a2a2f;color:var(--text)}
    .foot{margin-top:8px;color:var(--muted);font-size:12px}
    .formGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    @media (max-width:720px){.formGrid{grid-template-columns:1fr}}
    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}
    input,select{
      width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);
      background:#0f0f12;color:var(--text);outline:none
    }
    .miniRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .miniRow .miniBtn{
      border:1px solid var(--line);background:#0f0f12;color:var(--text);
      padding:10px 12px;border-radius:12px;font-weight:800;cursor:pointer
    }
    .saveBadge{
      display:inline-flex;align-items:center;gap:6px;border:1px solid #2e7d32;color:#c8f7d2;
      border-radius:999px;padding:6px 10px;font-size:12px;margin-left:8px
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">뜻밖의시장</div>
    <div class="sub">지도에서 위치 확인 → 행사 선택 → 셀러 지원 (행사명 자동입력)</div>

    <div class="card">
      <h2>행사 지도</h2>
      <div class="help">핀을 눌러 행사 정보를 보고 선택할 수 있어요.</div>
      <div id="map"></div>
      <div class="foot" id="mapFoot"></div>
    </div>

    <div class="card">
      <h2>모집 현황</h2>
      <div class="help">행사별 참가 팀 수 (운영자 기준 자동 업데이트)</div>
      <div id="bars"></div>
    </div>

    <div class="card">
      <h2>출점 공고</h2>
      <div class="help">행사를 눌러 선택하세요. 선택 후 “지원하기”를 누르면 구글폼에 행사명이 자동입력됩니다.</div>
      <div class="list" id="eventList"></div>

      <div class="selectedBox" id="selectedBox">선택된 행사 없음</div>

      <div class="btnRow">
        <button class="btn" id="applyBtn">이 행사로 지원하기</button>
        <button class="btn secondary" id="toggleAppliedBtn">신청완료 표시/해제</button>
      </div>

      <div class="foot">* “신청완료”는 이 기기에서만 표시됩니다(MVP용).</div>
    </div>

    <div class="card">
      <h2>기존 셀러 정보 (1회 저장)</h2>
      <div class="help">내 정보를 한 번 저장해두면, 다음 지원 때 자동으로 불러오게 만들 수 있어요(다음 단계에서 완성).</div>

      <div class="formGrid">
        <div>
          <label>상호명 / 브랜드명 *</label>
          <input id="sellerBrand" placeholder="예: 출출" />
        </div>
        <div>
          <label>대표자 이름 *</label>
          <input id="sellerName" placeholder="예: 전세운" />
        </div>
        <div>
          <label>휴대폰 번호 *</label>
          <input id="sellerPhone" placeholder="예: 01012345678" />
        </div>
        <div>
          <label>이메일 *</label>
          <input id="sellerEmail" placeholder="예: marketfindout@gmail.com" />
        </div>
        <div>
          <label>판매 카테고리 *</label>
          <select id="sellerCat">
            <option value="푸드">푸드</option>
            <option value="디저트">디저트</option>
            <option value="음료">음료</option>
            <option value="공예/소품">공예/소품</option>
            <option value="뷰티/리빙">뷰티/리빙</option>
            <option value="기타">기타</option>
          </select>
        </div>
        <div>
          <label>인스타그램 (선택)</label>
          <input id="sellerInsta" placeholder="예: @_marketmakers_" />
        </div>
      </div>

      <div class="miniRow">
        <button class="miniBtn" id="saveSellerBtn">내 정보 저장</button>
        <button class="miniBtn" id="clearSellerBtn">저장 삭제</button>
        <span id="sellerSavedTag" class="saveBadge" style="display:none;">저장됨</span>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  설정: 여기는 전세운님 상황에 맞게 나중에 더 연결
 * ========================= */
const EVENTS_URL = "./events.json"; // admin.html이 저장하는 파일
const SELLER_FORM_BASE = "https://docs.google.com/forms/d/e/1FAIpQLScbJPOJKWT_rNJaBsx81N86KelknR7EaWQ_dPvoGcXEcDTSSg/viewform";

// 구글폼 “행사명” 질문 entry (전세운님이 찾은 값)
const ENTRY_EVENT_NAME = "entry.1498135098";

// (다음 단계) 셀러 정보 자동입력까지 연결하려면 각 질문의 entry 번호가 필요해.
// 지금은 저장만 해두고, 폼에는 행사명만 자동입력한다.
const LS = {
  selectedEventId: "um_selected_event_id",
  appliedMap: "um_applied_map", // {"ev_id": true}
  seller: "um_seller_profile",
};

// ===== helpers
const $ = (id)=>document.getElementById(id);
function esc(s){ return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
function fmtRange(e){ return `${e.start||""} ~ ${e.end||""}`.trim(); }
function isFull(e){ return (Number(e.capacity||0) > 0) && (Number(e.current||0) >= Number(e.capacity||0)); }
function loadApplied(){ try{ return JSON.parse(localStorage.getItem(LS.appliedMap)||"{}"); }catch{ return {}; } }
function saveApplied(map){ localStorage.setItem(LS.appliedMap, JSON.stringify(map)); }

// ===== fetch events
async function loadEvents(){
  const bust = `?v=${Date.now()}`;
  const res = await fetch(EVENTS_URL + bust, {cache:"no-store"});
  if(!res.ok) throw new Error("events.json을 불러오지 못했습니다. 관리자에서 먼저 GitHub에 저장했는지 확인하세요.");
  const arr = await res.json();
  if(!Array.isArray(arr)) throw new Error("events.json 형식이 올바르지 않습니다(배열이 아님).");
  // normalize minimal
  return arr.map(e=>({
    id: e.id, name: e.name, area: e.area,
    start: e.start, end: e.end,
    address: e.address,
    lat: (e.lat===""||e.lat==null)? null : Number(e.lat),
    lng: (e.lng===""||e.lng==null)? null : Number(e.lng),
    capacity: Number(e.capacity||0),
    current: Number(e.current||0),
    status: e.status || (isFull(e) ? "마감":"모집중")
  }));
}

// ===== map
let map, markers = new Map();

function initMap(center=[37.2,127.07], zoom=10){
  map = L.map('map', {scrollWheelZoom:false});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:'&copy; OpenStreetMap contributors'
  }).addTo(map);
  map.setView(center, zoom);
}

function markerColor(e){
  // 마감이면 회색 느낌, 모집중이면 파란 느낌
  return isFull(e) || e.status==="마감" ? "#8b8b90" : "#4da3ff";
}

function addOrUpdateMarker(e){
  if(e.lat==null || e.lng==null) return;
  const color = markerColor(e);
  const html = `
    <div style="
      width:18px;height:18px;border-radius:999px;background:${color};
      border:3px solid rgba(255,255,255,0.85); box-shadow:0 6px 14px rgba(0,0,0,.45);
    "></div>`;
  const icon = L.divIcon({className:"", html, iconSize:[18,18], iconAnchor:[9,9]});

  let m = markers.get(e.id);
  if(!m){
    m = L.marker([e.lat, e.lng], {icon}).addTo(map);
    m.on("click", ()=>selectEvent(e.id, true));
    markers.set(e.id, m);
  }else{
    m.setIcon(icon);
  }

  const badge = isFull(e) ? "마감" : "모집중";
  m.bindPopup(`
    <b>${esc(e.name)}</b><br/>
    <span>${esc(fmtRange(e))}</span><br/>
    <span>${esc(e.area||"")}</span><br/>
    <span style="opacity:.8">${esc(e.address||"")}</span><br/>
    <span style="opacity:.85">${e.current} / ${e.capacity||"—"} 팀 · ${badge}</span>
  `);
}

// ===== UI render
let EVENTS = [];
function renderBars(){
  const el = $("bars");
  el.innerHTML = "";
  EVENTS.forEach(e=>{
    const pct = e.capacity>0 ? Math.min(100, Math.round((e.current/e.capacity)*100)) : 0;
    const item = document.createElement("div");
    item.className = "barItem";
    item.innerHTML = `
      <div class="barTop">
        <div class="barName">${esc(e.name)}</div>
        <div class="barNum">${esc(e.current)} / ${esc(e.capacity)}팀</div>
      </div>
      <div class="barBg"><div class="barFill" style="width:${pct}%;"></div></div>
    `;
    el.appendChild(item);
  });
}

function renderList(){
  const applied = loadApplied();
  const el = $("eventList");
  el.innerHTML = "";
  EVENTS
    .slice()
    .sort((a,b)=>(a.start||"").localeCompare(b.start||""))
    .forEach(e=>{
      const done = applied[e.id] ? true : false;
      const full = isFull(e) || e.status==="마감";
      const badge = done ? `<span class="badge ok">신청완료</span>` : (full ? `<span class="badge done">마감</span>` : ``);

      const div = document.createElement("div");
      div.className = "eventCard";
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start">
          <div>
            <div class="eventName">${esc(e.name)}</div>
            <div class="eventMeta">${esc(fmtRange(e))} · ${esc(e.area||"")}</div>
          </div>
          <div style="text-align:right">
            ${badge}
          </div>
        </div>
      `;
      div.addEventListener("click", ()=>selectEvent(e.id, true));
      el.appendChild(div);
    });
}

function renderSelected(){
  const id = localStorage.getItem(LS.selectedEventId) || "";
  const e = EVENTS.find(x=>x.id===id);
  if(!e){
    $("selectedBox").textContent = "선택된 행사 없음";
    return;
  }
  const full = isFull(e) || e.status==="마감";
  const applied = loadApplied()[e.id] ? true : false;
  const state = applied ? "신청완료" : (full ? "마감" : "모집중");
  $("selectedBox").innerHTML = `
    <b>${esc(e.name)}</b><br/>
    <span style="color:var(--muted)">${esc(fmtRange(e))} · ${esc(e.area||"")}</span><br/>
    <span style="color:var(--muted)">${esc(e.address||"")}</span><br/>
    <span style="color:var(--muted)">${e.current} / ${e.capacity||"—"} 팀 · ${state}</span>
  `;
}

function selectEvent(id, panTo=false){
  localStorage.setItem(LS.selectedEventId, id);
  const e = EVENTS.find(x=>x.id===id);
  if(panTo && e && e.lat!=null && e.lng!=null){
    map.setView([e.lat,e.lng], Math.max(map.getZoom(), 12));
    const m = markers.get(e.id);
    if(m) m.openPopup();
  }
  renderSelected();
}

// ===== Apply (Google Form)
function buildApplyUrl(e){
  const url = new URL(SELLER_FORM_BASE);
  url.searchParams.set(ENTRY_EVENT_NAME, e.name || "");
  // (다음 단계) seller profile entry들도 여기에 추가하면 “기존 정보 자동입력” 완성됨
  return url.toString();
}

$("applyBtn").addEventListener("click", ()=>{
  const id = localStorage.getItem(LS.selectedEventId)||"";
  const e = EVENTS.find(x=>x.id===id);
  if(!e){ alert("먼저 행사를 선택하세요."); return; }
  if(isFull(e) || e.status==="마감"){
    if(!confirm("이 행사는 정원이 완료(마감) 상태로 보입니다. 그래도 폼으로 이동할까요?")) return;
  }
  window.open(buildApplyUrl(e), "_blank");
});

$("toggleAppliedBtn").addEventListener("click", ()=>{
  const id = localStorage.getItem(LS.selectedEventId)||"";
  const e = EVENTS.find(x=>x.id===id);
  if(!e){ alert("먼저 행사를 선택하세요."); return; }
  const map = loadApplied();
  map[e.id] = !map[e.id];
  saveApplied(map);
  renderList();
  renderSelected();
});

// ===== Seller profile save (local only)
function loadSeller(){
  try{ return JSON.parse(localStorage.getItem(LS.seller)||"null"); }catch{ return null; }
}
function saveSeller(obj){
  localStorage.setItem(LS.seller, JSON.stringify(obj));
}
function applySellerToUI(s){
  if(!s) return;
  $("sellerBrand").value = s.brand||"";
  $("sellerName").value = s.name||"";
  $("sellerPhone").value = s.phone||"";
  $("sellerEmail").value = s.email||"";
  $("sellerCat").value = s.cat||"푸드";
  $("sellerInsta").value = s.insta||"";
  $("sellerSavedTag").style.display = "inline-flex";
}
$("saveSellerBtn").addEventListener("click", ()=>{
  const obj = {
    brand: $("sellerBrand").value.trim(),
    name: $("sellerName").value.trim(),
    phone: $("sellerPhone").value.trim(),
    email: $("sellerEmail").value.trim(),
    cat: $("sellerCat").value,
    insta: $("sellerInsta").value.trim(),
  };
  if(!obj.brand || !obj.name || !obj.phone || !obj.email){
    alert("필수 항목(상호/이름/전화/이메일)을 입력하세요.");
    return;
  }
  saveSeller(obj);
  $("sellerSavedTag").style.display = "inline-flex";
  alert("저장 완료");
});
$("clearSellerBtn").addEventListener("click", ()=>{
  localStorage.removeItem(LS.seller);
  $("sellerSavedTag").style.display = "none";
  alert("저장 삭제 완료");
});

// ===== boot
(async function(){
  try{
    EVENTS = await loadEvents();

    // map center: 첫 행사 좌표가 있으면 그쪽, 없으면 동탄 근처 기본값
    const first = EVENTS.find(e=>e.lat!=null && e.lng!=null);
    initMap(first ? [first.lat, first.lng] : [37.2,127.07], first ? 12 : 10);

    EVENTS.forEach(e=>addOrUpdateMarker(e));
    renderBars();
    renderList();

    // selected restore
    const selected = localStorage.getItem(LS.selectedEventId);
    if(selected && EVENTS.some(e=>e.id===selected)) renderSelected();
    else { localStorage.removeItem(LS.selectedEventId); renderSelected(); }

    // seller restore
    applySellerToUI(loadSeller());

    $("mapFoot").textContent = `행사 ${EVENTS.length}개 · (관리자에서 events.json 저장 시 자동 반영)`;
  }catch(err){
    alert(err.message);
    $("mapFoot").textContent = "events.json을 불러오지 못했습니다. 관리자 페이지에서 먼저 GitHub에 저장해주세요.";
  }
})();
</script>
</body>
</html>
