<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>뜻밖의시장 | 관리자</title>
  <style>
    :root{
      --bg:#0b0b0c; --card:#16161a; --muted:#a7a7aa; --text:#f4f4f6;
      --line:#2a2a2f; --accent:#ffffff; --danger:#ff4d4f; --ok:#35c759;
      --warn:#ffcc00;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo",system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:22px}
    .top{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;margin-bottom:14px}
    .title{font-size:28px;font-weight:900;letter-spacing:-0.5px}
    .sub{color:var(--muted);font-size:13px;margin-top:4px;line-height:1.4}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px}
    .card h2{margin:0 0 10px 0;font-size:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1 1 220px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{
      width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--line);
      background:#0f0f12;color:var(--text);outline:none
    }
    textarea{min-height:90px;resize:vertical}
    .btnbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      border:0;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer;
      background:var(--accent);color:#000;flex:0 0 auto
    }
    .btn.secondary{background:#2a2a2f;color:var(--text)}
    .btn.danger{background:var(--danger);color:#fff}
    .btn.ok{background:var(--ok);color:#000}
    .btn.warn{background:var(--warn);color:#000}
    .mini{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.5}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--line);border-radius:14px;padding:12px;background:#0f0f12}
    .itemTop{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .name{font-weight:900}
    .meta{color:var(--muted);font-size:12px;margin-top:4px}
    .tag{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
    .tag.ok{border-color:#2e7d32;color:#c8f7d2}
    .tag.done{border-color:#6b6b70;color:#d0d0d2}
    .tag.warn{border-color:#b08900;color:#ffe082}
    .muted{color:var(--muted)}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .box{flex:1 1 180px;border:1px solid var(--line);border-radius:14px;padding:12px;background:#0f0f12}
    .box .big{font-size:18px;font-weight:900}
    .box .small{font-size:12px;color:var(--muted);margin-top:4px}
    .toast{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0f0f12;font-size:12px;color:var(--muted)}
    .toast strong{color:var(--text)}
    .hidden{display:none!important}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;word-break:break-all}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="title">뜻밖의시장 <span class="muted">관리자</span></div>
        <div class="sub">메인 화면(index.html)은 건드리지 않고, <b>events.json</b> 같은 “데이터 파일”만 저장해서 메인에 자동 반영시키는 구조입니다.</div>
      </div>
      <div class="pill" id="statusPill">상태: <b id="statusText">로그인 필요</b></div>
    </div>

    <!-- 로그인 -->
    <div class="card" id="loginCard">
      <h2>1) 관리자 로그인</h2>
      <div class="mini">MVP라서 “진짜 계정 로그인” 대신, <b>허용된 이메일(최대 3개)</b> + 공통 PIN으로 관리자 접근을 막습니다. (서버 없이 GitHub Pages로만 운영 가능)</div>

      <label>관리자 이메일</label>
      <input id="loginEmail" placeholder="예: marketfindout@gmail.com" />

      <label>관리자 PIN(공통)</label>
      <input id="loginPin" placeholder="예: 1234" />

      <div class="btnbar">
        <button class="btn" id="loginBtn">로그인</button>
        <button class="btn secondary" id="logoutBtn">로그아웃</button>
      </div>
      <div class="toast" id="loginToast"><strong>설정 위치</strong> : 이 파일 상단 스크립트의 <span class="mono">ADMIN_EMAILS</span> / <span class="mono">ADMIN_PIN</span>만 바꾸면 됩니다.</div>
    </div>

    <div class="grid">
      <!-- GitHub 연결 -->
      <div class="card" id="ghCard">
        <h2>2) GitHub 저장 연결</h2>
        <div class="mini">방금 만든 Fine-grained 토큰을 여기에 넣으면, 관리자 페이지에서 <b>events.json 저장</b>이 가능해집니다.</div>

        <label>Owner</label>
        <input id="ghOwner" value="jeonsewoon" />

        <label>Repository</label>
        <input id="ghRepo" value="seller-mvp" />

        <label>GitHub Token (Fine-grained)</label>
        <input id="ghToken" placeholder="github_pat_... (여기에만 붙여넣기)" />

        <div class="btnbar">
          <button class="btn secondary" id="saveGhBtn">토큰 저장</button>
          <button class="btn" id="testGhBtn">연결 테스트</button>
        </div>
        <div class="toast" id="ghToast">연결 테스트를 누르면 <b>events.json 읽기</b>를 시도합니다.</div>
      </div>

      <!-- 요약 -->
      <div class="card" id="summaryCard">
        <h2>요약</h2>
        <div class="kpi">
          <div class="box">
            <div class="big" id="kpiEvents">0</div>
            <div class="small">등록된 행사 수</div>
          </div>
          <div class="box">
            <div class="big" id="kpiOpen">0</div>
            <div class="small">모집중 행사</div>
          </div>
          <div class="box">
            <div class="big" id="kpiFull">0</div>
            <div class="small">마감(정원완료)</div>
          </div>
        </div>
        <div class="hr"></div>
        <div class="mini">
          ✅ 저장되는 파일: <span class="mono">/events.json</span><br/>
          ✅ 메인화면은 다음 업그레이드에서 <span class="mono">events.json</span>을 읽어 자동 반영합니다.<br/>
          ✅ 핀 색상/완료 표시는 <b>current &gt;= capacity</b>면 자동으로 “마감” 처리됩니다.
        </div>
      </div>

      <!-- 행사 편집 -->
      <div class="card" id="editorCard">
        <h2>3) 행사 추가 / 수정</h2>
        <div class="mini">주소/좌표는 나중에 자동지오코딩 붙일 수 있어요(MVP는 수동 입력). 메인 화면의 UI는 절대 건드리지 않습니다.</div>

        <label>행사 ID (자동 생성 / 수정 시 유지)</label>
        <input id="evId" placeholder="자동" disabled />

        <div class="row">
          <div>
            <label>행사명</label>
            <input id="evName" placeholder="예: 동탄역 롯데캐슬" />
          </div>
          <div>
            <label>지역(표시용)</label>
            <input id="evArea" placeholder="예: 동탄" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>시작일</label>
            <input id="evStart" type="date" />
          </div>
          <div>
            <label>종료일</label>
            <input id="evEnd" type="date" />
          </div>
        </div>

        <label>주소(실제 존재하는 주소/아파트명)</label>
        <input id="evAddress" placeholder="예: 경기도 화성시 동탄..." />

        <div class="row">
          <div>
            <label>위도(lat)</label>
            <input id="evLat" placeholder="예: 37.2000" />
          </div>
          <div>
            <label>경도(lng)</label>
            <input id="evLng" placeholder="예: 127.0700" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>정원(capacity)</label>
            <input id="evCap" type="number" min="0" placeholder="예: 30" />
          </div>
          <div>
            <label>현재(current)</label>
            <input id="evCur" type="number" min="0" placeholder="예: 18" />
          </div>
        </div>

        <label>비고(운영 메모)</label>
        <textarea id="evNote" placeholder="예: 전기/주차/반입 동선 등"></textarea>

        <div class="btnbar">
          <button class="btn ok" id="newBtn">새 행사</button>
          <button class="btn" id="saveBtn">저장(목록 반영)</button>
          <button class="btn danger" id="deleteBtn">삭제</button>
          <button class="btn secondary" id="resetBtn">입력 초기화</button>
        </div>

        <div class="toast" id="editToast">
          <strong>팁</strong> 저장 후 “GitHub에 저장”까지 해야 실제 배포 파일(<span class="mono">events.json</span>)이 바뀝니다.
        </div>
      </div>

      <!-- 행사 목록 -->
      <div class="card" id="listCard">
        <h2>4) 행사 목록</h2>
        <div class="mini">행사를 클릭하면 수정 모드로 들어갑니다. 정원 완료면 자동으로 “마감” 태그가 붙습니다.</div>
        <div class="list" id="eventList"></div>

        <div class="hr"></div>
        <div class="btnbar">
          <button class="btn" id="loadBtn">GitHub에서 불러오기</button>
          <button class="btn ok" id="pushBtn">GitHub에 저장(events.json)</button>
          <button class="btn secondary" id="exportBtn">CSV 내보내기</button>
        </div>

        <div class="toast" id="ioToast">처음엔 “GitHub에 저장”을 눌러 <span class="mono">events.json</span> 파일을 생성하세요.</div>
      </div>
    </div>

    <div class="card">
      <h2>다음 업그레이드(내일 진행)</h2>
      <div class="mini">
        1) 신규 행사 등록 시 셀러 알림(웹푸시/이메일/카톡 연동) — MVP는 “공지 배너”부터<br/>
        2) 셀러 신청 목록 조회/상태관리(대기/승인/불가) + 강퇴(블랙리스트) + CSV<br/>
        3) 지도 핀 자동 색상(모집완료 회색) / 메인 막대그래프 자동 반영 고도화
      </div>
    </div>

  </div>

  <script>
    /***********************
     * 관리자 설정(여기만 바꾸면 됨)
     ***********************/
    const ADMIN_EMAILS = [
      "marketfindout@gmail.com",  // 관리자1
      "admin2@example.com",       // 관리자2 (바꿔)
      "admin3@example.com"        // 관리자3 (바꿔)
    ];
    const ADMIN_PIN = "1234"; // 공통 PIN (원하는 값으로 변경)

    /***********************
     * localStorage keys
     ***********************/
    const LS = {
      loggedIn: "um_admin_logged_in",
      email: "um_admin_email",
      ghOwner: "um_gh_owner",
      ghRepo: "um_gh_repo",
      ghToken: "um_gh_token",
      events: "um_events_cache"
    };

    /***********************
     * UI helpers
     ***********************/
    const $ = (id) => document.getElementById(id);
    const setToast = (id, html) => { $(id).innerHTML = html; };

    function setStatus(text){
      $("statusText").textContent = text;
    }

    function isLoggedIn(){
      return localStorage.getItem(LS.loggedIn) === "1";
    }

    function requireLogin(){
      if(!isLoggedIn()){
        setStatus("로그인 필요");
        $("ghCard").classList.add("hidden");
        $("editorCard").classList.add("hidden");
        $("listCard").classList.add("hidden");
        $("summaryCard").classList.add("hidden");
      }else{
        setStatus("관리자 모드");
        $("ghCard").classList.remove("hidden");
        $("editorCard").classList.remove("hidden");
        $("listCard").classList.remove("hidden");
        $("summaryCard").classList.remove("hidden");
      }
    }

    /***********************
     * events model
     ***********************/
    function uuid(){
      return "ev_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    function normalizeEvent(e){
      const cap = Number(e.capacity ?? 0);
      const cur = Number(e.current ?? 0);
      const isFull = cap > 0 && cur >= cap;
      return {
        id: e.id || uuid(),
        name: (e.name || "").trim(),
        area: (e.area || "").trim(),
        start: e.start || "",
        end: e.end || "",
        address: (e.address || "").trim(),
        lat: e.lat === "" ? "" : (e.lat ?? ""),
        lng: e.lng === "" ? "" : (e.lng ?? ""),
        capacity: isNaN(cap) ? 0 : cap,
        current: isNaN(cur) ? 0 : cur,
        note: (e.note || "").trim(),
        status: isFull ? "마감" : "모집중",
        updatedAt: new Date().toISOString()
      };
    }

    function loadCache(){
      try{
        const raw = localStorage.getItem(LS.events);
        if(!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }

    function saveCache(arr){
      localStorage.setItem(LS.events, JSON.stringify(arr));
      renderAll();
    }

    function stats(arr){
      const total = arr.length;
      const full = arr.filter(x => x.status === "마감").length;
      const open = total - full;
      return {total, open, full};
    }

    /***********************
     * GitHub API (Contents)
     ***********************/
    function b64encode(str){
      return btoa(unescape(encodeURIComponent(str)));
    }
    function b64decode(b64){
      return decodeURIComponent(escape(atob(b64)));
    }

    function ghConfig(){
      const owner = ($("ghOwner").value || "").trim();
      const repo = ($("ghRepo").value || "").trim();
      const token = ($("ghToken").value || "").trim();
      return {owner, repo, token};
    }

    async function ghGetFile(path){
      const {owner, repo, token} = ghConfig();
      const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
      const res = await fetch(url, {
        headers: {
          "Accept":"application/vnd.github+json",
          "Authorization": `Bearer ${token}`
        }
      });
      if(res.status === 404) return {exists:false};
      if(!res.ok){
        const t = await res.text();
        throw new Error(`GitHub 읽기 실패 (${res.status}) ${t}`);
      }
      const data = await res.json();
      return {exists:true, data};
    }

    async function ghPutFile(path, contentStr, message){
      const {owner, repo, token} = ghConfig();
      const existing = await ghGetFile(path);
      const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
      const body = {
        message: message || `Update ${path}`,
        content: b64encode(contentStr)
      };
      if(existing.exists && existing.data && existing.data.sha){
        body.sha = existing.data.sha;
      }
      const res = await fetch(url, {
        method:"PUT",
        headers: {
          "Accept":"application/vnd.github+json",
          "Authorization": `Bearer ${token}`,
          "Content-Type":"application/json"
        },
        body: JSON.stringify(body)
      });
      const t = await res.text();
      if(!res.ok) throw new Error(`GitHub 저장 실패 (${res.status}) ${t}`);
      return JSON.parse(t);
    }

    /***********************
     * Render
     ***********************/
    function renderList(arr){
      const el = $("eventList");
      el.innerHTML = "";
      if(arr.length === 0){
        el.innerHTML = `<div class="item"><div class="muted">등록된 행사가 없습니다. “새 행사”로 추가하세요.</div></div>`;
        return;
      }

      const sorted = [...arr].sort((a,b) => (a.start||"").localeCompare(b.start||""));
      for(const ev of sorted){
        const isFull = ev.status === "마감";
        const tagClass = isFull ? "done" : "ok";
        const tagText = isFull ? "마감(정원완료)" : "모집중";
        const cap = ev.capacity || 0;
        const cur = ev.current || 0;

        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="itemTop">
            <div>
              <div class="name">${escapeHtml(ev.name || "(제목없음)")}</div>
              <div class="meta">${escapeHtml(ev.start || "")} ~ ${escapeHtml(ev.end || "")} · ${escapeHtml(ev.area || "")}</div>
              <div class="meta">${escapeHtml(ev.address || "")}</div>
            </div>
            <div style="text-align:right">
              <div class="tag ${tagClass}">${tagText}</div>
              <div class="meta">${cur} / ${cap || "—"} 팀</div>
            </div>
          </div>
        `;
        div.addEventListener("click", () => loadToEditor(ev.id));
        el.appendChild(div);
      }
    }

    function renderKPIs(arr){
      const s = stats(arr);
      $("kpiEvents").textContent = String(s.total);
      $("kpiOpen").textContent = String(s.open);
      $("kpiFull").textContent = String(s.full);
    }

    function renderAll(){
      const arr = loadCache();
      renderKPIs(arr);
      renderList(arr);
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }

    /***********************
     * Editor
     ***********************/
    function clearEditor(){
      $("evId").value = "";
      $("evName").value = "";
      $("evArea").value = "";
      $("evStart").value = "";
      $("evEnd").value = "";
      $("evAddress").value = "";
      $("evLat").value = "";
      $("evLng").value = "";
      $("evCap").value = "";
      $("evCur").value = "";
      $("evNote").value = "";
      setToast("editToast", `<strong>팁</strong> 저장 후 “GitHub에 저장”까지 해야 실제 배포 파일(<span class="mono">events.json</span>)이 바뀝니다.`);
    }

    function editorValue(){
      const raw = {
        id: $("evId").value || "",
        name: $("evName").value,
        area: $("evArea").value,
        start: $("evStart").value,
        end: $("evEnd").value,
        address: $("evAddress").value,
        lat: $("evLat").value,
        lng: $("evLng").value,
        capacity: $("evCap").value,
        current: $("evCur").value,
        note: $("evNote").value
      };
      return normalizeEvent(raw);
    }

    function loadToEditor(id){
      const arr = loadCache();
      const ev = arr.find(x => x.id === id);
      if(!ev) return;
      $("evId").value = ev.id || "";
      $("evName").value = ev.name || "";
      $("evArea").value = ev.area || "";
      $("evStart").value = ev.start || "";
      $("evEnd").value = ev.end || "";
      $("evAddress").value = ev.address || "";
      $("evLat").value = ev.lat ?? "";
      $("evLng").value = ev.lng ?? "";
      $("evCap").value = ev.capacity ?? "";
      $("evCur").value = ev.current ?? "";
      $("evNote").value = ev.note || "";

      setToast("editToast",
        `<strong>수정 모드</strong> : “저장(목록 반영)” → “GitHub에 저장(events.json)” 순서로 반영하세요.`
      );
    }

    function upsertEvent(ev){
      const arr = loadCache();
      const idx = arr.findIndex(x => x.id === ev.id);
      if(idx >= 0) arr[idx] = ev;
      else arr.push(ev);
      saveCache(arr);
    }

    function deleteEvent(id){
      const arr = loadCache().filter(x => x.id !== id);
      saveCache(arr);
      clearEditor();
    }

    /***********************
     * CSV export
     ***********************/
    function toCSV(arr){
      const cols = ["id","name","area","start","end","address","lat","lng","capacity","current","status","note","updatedAt"];
      const head = cols.join(",");
      const lines = arr.map(o => cols.map(k => {
        const v = (o[k] ?? "").toString().replaceAll('"','""');
        return `"${v}"`;
      }).join(","));
      return [head, ...lines].join("\n");
    }

    function downloadFile(filename, content, mime){
      const blob = new Blob([content], {type: mime || "text/plain"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /***********************
     * Login + init
     ***********************/
    function init(){
      // preload gh config
      $("ghOwner").value = localStorage.getItem(LS.ghOwner) || "jeonsewoon";
      $("ghRepo").value = localStorage.getItem(LS.ghRepo) || "seller-mvp";
      $("ghToken").value = localStorage.getItem(LS.ghToken) || "";

      // preload login
      const email = localStorage.getItem(LS.email) || "";
      $("loginEmail").value = email;

      // events cache bootstrap (keep if exists)
      renderAll();
      requireLogin();
    }

    // login actions
    $("loginBtn").addEventListener("click", () => {
      const email = ($("loginEmail").value || "").trim().toLowerCase();
      const pin = ($("loginPin").value || "").trim();
      if(!email){
        setToast("loginToast", `<strong style="color:var(--danger)">이메일을 입력하세요.</strong>`);
        return;
      }
      if(!ADMIN_EMAILS.map(x=>x.toLowerCase()).includes(email)){
        setToast("loginToast", `<strong style="color:var(--danger)">허용되지 않은 관리자 이메일입니다.</strong><br/>ADMIN_EMAILS에 등록된 이메일만 가능합니다.`);
        return;
      }
      if(pin !== ADMIN_PIN){
        setToast("loginToast", `<strong style="color:var(--danger)">PIN이 틀렸습니다.</strong>`);
        return;
      }
      localStorage.setItem(LS.loggedIn, "1");
      localStorage.setItem(LS.email, email);
      setToast("loginToast", `<strong style="color:var(--ok)">로그인 성공</strong> · ${escapeHtml(email)}`);
      requireLogin();
    });

    $("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem(LS.loggedIn);
      setToast("loginToast", `<strong>로그아웃</strong> 완료`);
      requireLogin();
    });

    // gh actions
    $("saveGhBtn").addEventListener("click", () => {
      localStorage.setItem(LS.ghOwner, ($("ghOwner").value || "").trim());
      localStorage.setItem(LS.ghRepo, ($("ghRepo").value || "").trim());
      localStorage.setItem(LS.ghToken, ($("ghToken").value || "").trim());
      setToast("ghToast", `<strong style="color:var(--ok)">저장됨</strong> · 이제 “연결 테스트”를 눌러보세요.`);
    });

    $("testGhBtn").addEventListener("click", async () => {
      try{
        setToast("ghToast", `연결 테스트 중...`);
        const r = await ghGetFile("events.json");
        if(!r.exists){
          setToast("ghToast", `<strong style="color:var(--warn)">OK</strong> · events.json이 아직 없습니다. “GitHub에 저장”을 누르면 생성됩니다.`);
        }else{
          setToast("ghToast", `<strong style="color:var(--ok)">연결 성공</strong> · events.json 읽기 가능`);
        }
      }catch(e){
        setToast("ghToast", `<strong style="color:var(--danger)">연결 실패</strong><br/><span class="mono">${escapeHtml(e.message)}</span>`);
      }
    });

    // editor actions
    $("newBtn").addEventListener("click", () => {
      clearEditor();
      $("evId").value = uuid();
      setToast("editToast", `<strong>새 행사</strong> : 입력 후 “저장(목록 반영)”을 누르세요.`);
    });

    $("saveBtn").addEventListener("click", () => {
      const ev = editorValue();
      if(!ev.name){
        setToast("editToast", `<strong style="color:var(--danger)">행사명을 입력하세요.</strong>`);
        return;
      }
      if(!ev.start || !ev.end){
        setToast("editToast", `<strong style="color:var(--danger)">시작일/종료일을 입력하세요.</strong>`);
        return;
      }
      // id ensure
      if(!$("evId").value) $("evId").value = ev.id;
      upsertEvent(ev);
      setToast("editToast", `<strong style="color:var(--ok)">목록 반영 완료</strong> · 이제 “GitHub에 저장(events.json)”을 눌러 배포 반영하세요.`);
    });

    $("deleteBtn").addEventListener("click", () => {
      const id = $("evId").value;
      if(!id){
        setToast("editToast", `<strong style="color:var(--warn)">삭제할 행사를 먼저 선택하세요.</strong>`);
        return;
      }
      if(confirm("정말 삭제할까요? (되돌리기 어려움)")){
        deleteEvent(id);
        setToast("editToast", `<strong style="color:var(--ok)">삭제 완료</strong>`);
      }
    });

    $("resetBtn").addEventListener("click", () => {
      clearEditor();
    });

    // io actions
    $("loadBtn").addEventListener("click", async () => {
      try{
        setToast("ioToast", "GitHub에서 불러오는 중...");
        const r = await ghGetFile("events.json");
        if(!r.exists){
          setToast("ioToast", `<strong style="color:var(--warn)">events.json 없음</strong> · 먼저 “GitHub에 저장”으로 생성하세요.`);
          return;
        }
        const content = b64decode(r.data.content || "");
        const arr = JSON.parse(content);
        if(!Array.isArray(arr)) throw new Error("events.json 형식이 배열(Array)이 아닙니다.");
        // normalize all
        const normalized = arr.map(normalizeEvent);
        saveCache(normalized);
        setToast("ioToast", `<strong style="color:var(--ok)">불러오기 완료</strong> · ${normalized.length}개 행사`);
      }catch(e){
        setToast("ioToast", `<strong style="color:var(--danger)">불러오기 실패</strong><br/><span class="mono">${escapeHtml(e.message)}</span>`);
      }
    });

    $("pushBtn").addEventListener("click", async () => {
      try{
        const arr = loadCache().map(normalizeEvent);
        setToast("ioToast", "GitHub에 저장 중...");
        await ghPutFile("events.json", JSON.stringify(arr, null, 2), "Update events.json via admin");
        setToast("ioToast", `<strong style="color:var(--ok)">저장 성공</strong> · events.json 배포 반영 완료`);
      }catch(e){
        setToast("ioToast", `<strong style="color:var(--danger)">저장 실패</strong><br/><span class="mono">${escapeHtml(e.message)}</span>`);
      }
    });

    $("exportBtn").addEventListener("click", () => {
      const arr = loadCache();
      const csv = toCSV(arr);
      downloadFile("events.csv", csv, "text/csv;charset=utf-8");
      setToast("ioToast", `<strong style="color:var(--ok)">CSV 다운로드</strong> 완료`);
    });

    // boot
    init();
  </script>
</body>
</html>
