<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b0b0c" />
  <title>뜻밖의 시장 | 셀러 전시</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{--bg:#0b0b0c;--card:#16161a;--soft:rgba(255,255,255,.06);--line:rgba(255,255,255,.12);--muted:#b2b2b8;}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;background:var(--bg);color:#f4f4f6}
    .wrap{max-width:860px;margin:0 auto;padding:22px 16px 92px}
    .heroTitle{font-size:36px;font-weight:900;letter-spacing:-0.02em;color:#fff;margin:6px 0 8px}
    .heroSub{color:var(--muted);font-size:14px;margin:0 0 14px;line-height:1.5}
    .card{margin-top:14px;padding:16px;border-radius:18px;background:var(--card);border:1px solid var(--line)}
    h2{font-size:16px;margin:0 0 10px}
    .muted{color:var(--muted);font-size:13px;line-height:1.55}
    .hr{height:1px;background:var(--line);margin:14px 0}
    #map{height:360px;margin-top:10px;border-radius:14px;border:1px solid var(--line);overflow:hidden}
    .item{padding:14px;border-radius:14px;background:var(--soft);border:1px solid var(--line);margin-bottom:10px;cursor:pointer}
    .item b{font-size:16px}
    .tag{display:inline-block;font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.16);color:#cfcfd3;background:rgba(255,255,255,.05);margin-left:8px}
    .tag.ok{border-color:rgba(120,255,180,.22);color:rgba(170,255,205,.95);background:rgba(120,255,180,.06)}
    .tag.done{border-color:rgba(255,255,255,.18);color:#e7e7ea;background:rgba(255,255,255,.10)}
    .tag.warn{border-color:rgba(255,77,79,.35);color:#ffd6d6;background:rgba(255,77,79,.10)}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .btn{display:inline-block;border:0;padding:12px 14px;border-radius:14px;background:#fff;color:#000;font-weight:900;text-decoration:none;cursor:pointer}
    .btn.sub{background:rgba(255,255,255,.10);color:#fff;font-weight:700;border:1px solid rgba(255,255,255,.16)}
    label{display:block;font-size:12px;color:#d0d0d6;margin:10px 0 6px}
    input, select{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25);color:#fff;font-size:14px;outline:none}
    input::placeholder{color:rgba(255,255,255,.35)}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:760px){ .grid{grid-template-columns:1fr 1fr} }
    .selectedBox{padding:14px;border-radius:14px;background:rgba(255,255,255,.04);border:1px dashed rgba(255,255,255,.22)}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;z-index:50;background:rgba(0,0,0,.80);border:1px solid rgba(255,255,255,.18);padding:10px 12px;border-radius:999px;font-size:13px;display:none;max-width:92vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .barRow{margin:10px 0}
    .barTop{display:flex;justify-content:space-between;gap:12px;align-items:flex-end}
    .barName{font-weight:900}
    .barMeta{color:var(--muted);font-size:12px}
    .barTrack{height:10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid var(--line);overflow:hidden;margin-top:8px}
    .barFill{height:100%;background:#fff;border-radius:999px}

    .noteBox{
      margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);color:#e7e7ea;font-size:12px;white-space:pre-wrap
    }
    .dangerNote{
      margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,77,79,.35);
      background:rgba(255,77,79,.10);color:#ffd6d6;font-size:12px;display:none;white-space:pre-wrap
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="heroTitle">뜻밖의 시장</div>
    <div class="heroSub">지도에서 위치 확인 → 행사 선택 → 셀러 지원(행사명 자동입력)</div>

    <div class="card">
      <h2>행사지도</h2>
      <div class="muted">좌표(lat/lng)가 입력된 행사만 지도에 핀이 표시됩니다. (좌표는 옵션)</div>
      <div id="map"></div>
      <div class="noteBox" id="mapNote" style="display:none"></div>
      <div class="dangerNote" id="mapWarn"></div>
    </div>

    <div class="card">
      <h2>모집 현황</h2>
      <div class="muted">행사별 참가 팀 수(운영자 기준 업데이트)</div>
      <div class="hr"></div>
      <div id="stats"></div>
      <div class="dangerNote" id="statsWarn"></div>
    </div>

    <div class="card">
      <h2>출점 공고</h2>
      <div class="muted">행사를 선택하세요. 선택 후 “지원하기”를 누르면 Google 폼에 행사명이 자동입력됩니다.</div>

      <div class="hr"></div>
      <div id="eventList"></div>
      <div class="dangerNote" id="listWarn"></div>

      <div class="hr"></div>
      <div class="selectedBox">
        <b id="selName">선택된 행사 없음</b>
        <span class="tag ok" id="selBadge" style="display:none">선택됨</span>
        <span class="tag done" id="selDoneBadge" style="display:none">신청완료</span>
        <br />
        <span class="muted" id="selMeta"></span>
      </div>

      <div class="btnRow">
        <a class="btn" id="applyBtn"
           href="https://docs.google.com/forms/d/e/1FAIpQLScbJPOJKWT_rNJaBsx81N86KelknR7EaWQ_dPvoGcXEcDTSSg/viewform">
          이 행사를 지원하기
        </a>
        <button class="btn sub" id="markDoneBtn" type="button">신청완료표시/해제</button>
      </div>

      <div class="muted" style="margin-top:10px">
        * “신청완료”는 이 기기에서만 표시됩니다(MVP용).
      </div>
    </div>

    <div class="card">
      <h2>기존 셀러 정보 (1회 저장)</h2>
      <div class="muted">전화번호/카테고리 등 구글폼 자동입력 확장 가능</div>
      <div class="hr"></div>

      <div class="grid">
        <div><label>상호명 *</label><input id="p_brand" placeholder="예) 출출빌라" /></div>
        <div><label>대표자 이름 *</label><input id="p_owner" placeholder="예) 전세운" /></div>
        <div><label>휴대폰번호 *</label><input id="p_phone" inputmode="tel" placeholder="예) 010-1234-5678" /></div>
        <div><label>이메일 *</label><input id="p_email" inputmode="email" placeholder="예) marketfindout@gmail.com" /></div>
        <div>
          <label>판매 카테고리 *</label>
          <select id="p_category">
            <option value="">선택</option>
            <option value="푸드">푸드</option>
            <option value="디저트">디저트</option>
            <option value="수공예">수공예</option>
            <option value="라이프스타일">라이프스타일</option>
            <option value="기타">기타</option>
          </select>
        </div>
        <div><label>인스타그램 (선택)</label><input id="p_insta" placeholder="예) @brandname" /></div>
      </div>

      <div class="btnRow">
        <button class="btn" id="saveProfile" type="button">내 정보 저장</button>
        <button class="btn sub" id="clearProfile" type="button">저장 삭제</button>
        <span class="tag" id="profileStatus">저장되지 않음</span>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  const SELLER_FORM_BASE =
    "https://docs.google.com/forms/d/e/1FAIpQLScbJPOJKWT_rNJaBsx81N86KelknR7EaWQ_dPvoGcXEcDTSSg/viewform";
  const ENTRY_EVENT_NAME = "entry.1498135098";

  const $ = (id) => document.getElementById(id);
  const toastEl = $("toast");
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(window.__t);
    window.__t = setTimeout(()=> toastEl.style.display="none", 2000);
  }

  const LS_PROFILE = "um_profile_v1";
  const LS_DONE = "um_done_v1";

  let EVENTS = [];
  let selected = null;
  let map = null;
  let markersLayer = null;

  const ZW = /[\u200B\u200C\u200D\uFEFF]/g;
  function cleanText(v){ return String(v ?? "").replace(ZW,"").trim(); }
  function safeStr(v){ return (v==null) ? "" : String(v); }
  function num(v, d=0){ const n = Number(v); return Number.isFinite(n) ? n : d; }
  function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
  function escapeHtml(s){ return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }

  function isFull(ev){
    const cap = num(ev.capacity, 0);
    const cur = num(ev.current, 0);
    return cap > 0 && cur >= cap;
  }

  function fmtDateRange(start, end){
    const s = cleanText(start);
    const e = cleanText(end);
    if(!s && !e) return "";
    return (s && e) ? `${s} ~ ${e}` : (s || e);
  }

  function normalizeEvent(raw){
    const ev = {
      id: cleanText(raw.id) || ("ev_" + Math.random().toString(16).slice(2)),
      name: cleanText(raw.name),
      area: cleanText(raw.area),
      start: cleanText(raw.start),
      end: cleanText(raw.end),
      address: cleanText(raw.address),
      lat: (raw.lat === null || raw.lat === "" || typeof raw.lat === "undefined") ? null : Number(raw.lat),
      lng: (raw.lng === null || raw.lng === "" || typeof raw.lng === "undefined") ? null : Number(raw.lng),
      capacity: num(raw.capacity, 0),
      current: num(raw.current, 0),
      note: cleanText(raw.note),
    };
    return ev;
  }

  function sortEvents(arr){
    return arr.slice().sort((a,b)=> safeStr(a.start).localeCompare(safeStr(b.start)));
  }

  function loadProfile(){ try { return JSON.parse(localStorage.getItem(LS_PROFILE)) || null; } catch { return null; } }
  function saveProfile(p){ localStorage.setItem(LS_PROFILE, JSON.stringify(p)); refreshProfileUI(); }
  function clearProfile(){ localStorage.removeItem(LS_PROFILE); refreshProfileUI(); }

  function refreshProfileUI(){
    const p = loadProfile();
    const tag = $("profileStatus");
    if(!p){
      tag.textContent = "저장되지 않음";
      tag.className = "tag";
      ["p_brand","p_owner","p_phone","p_email","p_insta"].forEach(k => $(k).value = "");
      $("p_category").value = "";
      return;
    }
    tag.textContent = "저장됨";
    tag.className = "tag ok";
    $("p_brand").value = p.brand || "";
    $("p_owner").value = p.owner || "";
    $("p_phone").value = p.phone || "";
    $("p_email").value = p.email || "";
    $("p_category").value = p.category || "";
    $("p_insta").value = p.insta || "";
  }

  function loadDone(){ try { return JSON.parse(localStorage.getItem(LS_DONE)) || {}; } catch { return {}; } }
  function isDone(id){ return !!loadDone()[id]; }
  function setDone(id, val){
    const d = loadDone();
    if(val) d[id] = true; else delete d[id];
    localStorage.setItem(LS_DONE, JSON.stringify(d));
    renderEventList();
    refreshSelectedBox();
  }

  function refreshSelectedBox(){
    if(!selected){
      $("selName").textContent = "선택된 행사 없음";
      $("selMeta").textContent = "";
      $("selBadge").style.display = "none";
      $("selDoneBadge").style.display = "none";
      return;
    }
    $("selName").textContent = selected.name;
    const dateText = fmtDateRange(selected.start, selected.end);
    const meta = [dateText, selected.area, selected.address].filter(Boolean).join(" · ");
    $("selMeta").textContent = meta;
    $("selBadge").style.display = "inline-block";
    $("selDoneBadge").style.display = isDone(selected.id) ? "inline-block" : "none";
  }

  function selectEventById(eventId){
    const ev = EVENTS.find(x=>x.id===eventId);
    if(!ev) return;
    selected = ev;
    refreshSelectedBox();
    toast("행사를 선택했어요");
  }

  function validateEventsForUI(){
    const bad = EVENTS.filter(ev => num(ev.capacity,0) < 1 || !ev.name || !ev.start || !ev.end);
    if(bad.length){
      $("listWarn").style.display = "block";
      $("listWarn").textContent =
        "⚠️ 데이터 오류가 있는 행사가 있습니다.\n" +
        "- 정원(capacity)은 1 이상이어야 합니다.\n" +
        "- 행사명/시작/종료는 필수입니다.\n\n" +
        "관리자(admin)에서 수정 후 GitHub 저장을 눌러주세요.";
    } else {
      $("listWarn").style.display = "none";
    }
  }

  function renderEventList(){
    const wrap = $("eventList");
    wrap.innerHTML = "";

    if(EVENTS.length === 0){
      $("listWarn").style.display = "block";
      $("listWarn").textContent = "행사 데이터가 없습니다. 관리자에서 events.json을 확인해주세요.";
      return;
    }

    EVENTS.forEach(ev=>{
      const div = document.createElement("div");
      div.className = "item";
      div.onclick = ()=> selectEventById(ev.id);

      const doneTag = isDone(ev.id) ? `<span class="tag ok">신청완료</span>` : ``;

      let statusTag = "";
      if(num(ev.capacity,0) < 1){
        statusTag = `<span class="tag warn">정원오류</span>`;
      } else {
        statusTag = isFull(ev) ? `<span class="tag done">마감</span>` : `<span class="tag ok">모집중</span>`;
      }

      const dateText = fmtDateRange(ev.start, ev.end);

      div.innerHTML = `
        <b>${escapeHtml(ev.name || "(이름없음)")}</b>
        ${doneTag}
        ${statusTag}
        <br><span class="muted">${escapeHtml(dateText)} · ${escapeHtml(ev.area || "")}</span>
      `;
      wrap.appendChild(div);
    });
  }

  function renderStats(){
    const el = $("stats");
    el.innerHTML = "";

    if(EVENTS.length === 0){
      $("statsWarn").style.display = "block";
      $("statsWarn").textContent = "모집 현황을 표시할 행사가 없습니다.";
      return;
    }
    $("statsWarn").style.display = "none";

    EVENTS.forEach(ev=>{
      const cap = num(ev.capacity, 0);
      const cur = num(ev.current, 0);

      const row = document.createElement("div");
      row.className = "barRow";

      if(cap < 1){
        row.innerHTML = `
          <div class="barTop">
            <div class="barName">${escapeHtml(ev.name || "(이름없음)")}</div>
            <div class="barMeta"><span class="tag warn">정원 미입력</span></div>
          </div>
          <div class="barTrack"><div class="barFill" style="width:0%"></div></div>
        `;
      } else {
        const pct = clamp(Math.round((cur / cap) * 100), 0, 100);
        row.innerHTML = `
          <div class="barTop">
            <div class="barName">${escapeHtml(ev.name)}</div>
            <div class="barMeta">${cur} / ${cap}팀</div>
          </div>
          <div class="barTrack"><div class="barFill" style="width:${pct}%"></div></div>
        `;
      }
      el.appendChild(row);
    });
  }

  function makeIcon(color){
    return L.divIcon({
      className: "",
      html: `<div style="width:14px;height:14px;border-radius:999px;background:${color};border:2px solid rgba(255,255,255,.9);box-shadow:0 6px 16px rgba(0,0,0,.45);"></div>`,
      iconSize: [14,14],
      iconAnchor: [7,7],
      popupAnchor: [0,-8],
    });
  }

  function initMap(){
    if(map) return;
    map = L.map("map", { scrollWheelZoom:false }).setView([37.5665, 126.9780], 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "© OpenStreetMap contributors" }).addTo(map);
    markersLayer = L.layerGroup().addTo(map);
  }

  function renderMapPins(){
    initMap();
    markersLayer.clearLayers();

    const pts = [];

    EVENTS.forEach(ev=>{
      const lat = ev.lat, lng = ev.lng;
      if(typeof lat !== "number" || typeof lng !== "number" || Number.isNaN(lat) || Number.isNaN(lng)) return;

      pts.push([lat,lng]);

      const color = isFull(ev) ? "rgba(255,255,255,.65)" : "#ffffff";
      const marker = L.marker([lat, lng], { icon: makeIcon(color) }).addTo(markersLayer);

      const dateText = fmtDateRange(ev.start, ev.end);
      const addr = ev.address ? `<span style="color:#9a9aa0">${escapeHtml(ev.address)}</span><br>` : ``;

      marker.bindPopup(`
        <b>${escapeHtml(ev.name)}</b><br>
        <span>${escapeHtml(dateText)}</span><br>
        ${addr}
        <button style="margin-top:8px;padding:8px 10px;border-radius:10px;border:0;font-weight:900;cursor:pointer"
          onclick="window.__pick('${encodeURIComponent(ev.id)}')"
        >이 행사 선택</button>
      `);
    });

    window.__pick = (idEnc)=>{ selectEventById(decodeURIComponent(idEnc)); map.closePopup(); };

    if(pts.length > 0){
      const bounds = L.latLngBounds(pts);
      map.fitBounds(bounds, { padding:[30,30] });
      $("mapWarn").style.display = "none";
      $("mapNote").style.display = "none";
    } else {
      // 좌표 없음은 에러가 아니라 “정상 안내”
      $("mapWarn").style.display = "none";
      $("mapNote").style.display = "block";
      $("mapNote").textContent =
        "지도 핀은 좌표(lat/lng)가 입력된 행사만 표시됩니다.\n" +
        "현재 행사들은 좌표가 비어 있어 핀이 숨겨진 상태입니다. (정상)";
    }
  }

  function buildPrefilledFormUrl(ev){
    const dateText = fmtDateRange(ev.start, ev.end);
    const eventValue = dateText ? `${ev.name} (${dateText})` : `${ev.name}`;
    const qs = `${ENTRY_EVENT_NAME}=${encodeURIComponent(eventValue)}`;
    return `${SELLER_FORM_BASE}?usp=pp_url&${qs}`;
  }

  async function loadEvents(){
    const url = `./events.json?ts=${Date.now()}`;
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`events.json 불러오기 실패 (${res.status})`);
    const data = await res.json();
    if(!Array.isArray(data)) throw new Error("events.json 형식 오류(배열이 아님)");
    return sortEvents(data.map(normalizeEvent));
  }

  $("saveProfile").addEventListener("click", () => {
    const p = {
      brand: $("p_brand").value.trim(),
      owner: $("p_owner").value.trim(),
      phone: $("p_phone").value.trim(),
      email: $("p_email").value.trim(),
      category: $("p_category").value.trim(),
      insta: $("p_insta").value.trim()
    };
    if(!p.brand || !p.owner || !p.phone || !p.email || !p.category){
      toast("필수 항목(상호/이름/전화/이메일/카테고리)을 입력해 주세요");
      return;
    }
    saveProfile(p);
    toast("내 정보 저장 ✅");
  });

  $("clearProfile").addEventListener("click", () => {
    clearProfile();
    toast("저장 삭제됨");
  });

  $("markDoneBtn").addEventListener("click", () => {
    if(!selected){ toast("먼저 행사를 선택해 주세요"); return; }
    setDone(selected.id, !isDone(selected.id));
    toast(isDone(selected.id) ? "신청완료 표시 ✅" : "신청완료 해제");
  });

  $("applyBtn").addEventListener("click", (e) => {
    e.preventDefault();
    if(!selected){ toast("먼저 행사를 선택해 주세요"); return; }
    if(!loadProfile()){ toast("먼저 '기존 셀러 정보'를 저장해 주세요"); return; }

    // 정원 오류면 지원 막기(운영 룰)
    if(num(selected.capacity,0) < 1){
      toast("정원이 설정되지 않은 행사입니다. 관리자에게 문의해주세요.");
      return;
    }

    setDone(selected.id, true);
    const url = buildPrefilledFormUrl(selected);
    toast("구글폼으로 이동합니다…(행사명 자동입력)");
    window.location.href = url;
  });

  (async function boot(){
    refreshProfileUI();
    initMap();

    try{
      EVENTS = await loadEvents();
      validateEventsForUI();
      renderEventList();
      renderStats();
      renderMapPins();

      if(EVENTS.length > 0){
        selectEventById(EVENTS[0].id);
      }
    }catch(err){
      console.error(err);
      $("listWarn").style.display = "block";
      $("listWarn").textContent =
        "행사 데이터를 불러오지 못했습니다.\n" +
        "확인: events.json 파일이 존재하는지, 형식이 올바른지 확인하세요.\n\n" +
        `에러: ${err.message}`;

      $("statsWarn").style.display = "block";
      $("statsWarn").textContent = "모집 현황을 표시할 수 없습니다(데이터 로딩 실패).";

      $("mapWarn").style.display = "block";
      $("mapWarn").textContent = "지도 표시를 준비할 수 없습니다(데이터 로딩 실패).";
    }
  })();
</script>
</body>
</html>
